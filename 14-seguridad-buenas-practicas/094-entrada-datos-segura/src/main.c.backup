/**
 * @file main.c
 * @brief Programa principal para demostraciÃ³n de entrada segura
 */

#include "entrada_segura.h"

/**
 * @brief Muestra el menÃº principal
 */
void mostrar_menu(void) {
    printf("\n");
    printf("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n");
    printf("â•‘                 ENTRADA SEGURA - MenÃº Principal              â•‘\n");
    printf("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n");
    printf("â•‘  1. Demo bÃ¡sico: gets() vs fgets()                          â•‘\n");
    printf("â•‘  2. Tutorial interactivo completo                           â•‘\n");
    printf("â•‘  3. DemostraciÃ³n de tipos de entrada                        â•‘\n");
    printf("â•‘  4. DemostraciÃ³n de validaciÃ³n                              â•‘\n");
    printf("â•‘  5. ConfiguraciÃ³n avanzada                                  â•‘\n");
    printf("â•‘  6. Stress test de seguridad                                â•‘\n");
    printf("â•‘  7. Ver vulnerabilidades comunes                           â•‘\n");
    printf("â•‘  8. Ver buenas prÃ¡cticas                                    â•‘\n");
    printf("â•‘  9. Comparar funciones seguras vs inseguras                â•‘\n");
    printf("â•‘  0. Salir                                                   â•‘\n");
    printf("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    printf("Selecciona una opciÃ³n: ");
}

/**
 * @brief Demo del cÃ³digo original vs versiÃ³n segura
 */
void demo_codigo_original(void) {
    printf("\n");
    printf("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n");
    printf("â•‘           DEMO: CÃ“DIGO ORIGINAL vs VERSIÃ“N SEGURA           â•‘\n");
    printf("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    printf("\n");
    
    printf("ğŸ“‹ CÃ“DIGO ORIGINAL (INSEGURO):\n");
    printf("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n");
    printf("#include <stdio.h>\n\n");
    printf("int main(void) {\n");
    printf("    char nombre[10];\n");
    printf("    printf(\"Introduce tu nombre: \");\n");
    printf("    gets(nombre);  // âš ï¸ PELIGROSO: Sin lÃ­mite de buffer\n");
    printf("    printf(\"Hola, %%s\\n\", nombre);\n");
    printf("    return 0;\n");
    printf("}\n\n");
    
    printf("âŒ PROBLEMAS DEL CÃ“DIGO ORIGINAL:\n");
    printf("â€¢ gets() no verifica el tamaÃ±o del buffer\n");
    printf("â€¢ Puede escribir mÃ¡s allÃ¡ de los 10 caracteres\n");
    printf("â€¢ Causa buffer overflow y corrupciÃ³n de memoria\n");
    printf("â€¢ Comportamiento indefinido\n");
    printf("â€¢ Vulnerabilidad de seguridad crÃ­tica\n");
    printf("â€¢ gets() fue eliminada del estÃ¡ndar C11\n\n");
    
    printf("ğŸ“‹ VERSIÃ“N SEGURA:\n");
    printf("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n");
    printf("#include <stdio.h>\n");
    printf("#include <string.h>\n\n");
    printf("int main(void) {\n");
    printf("    char nombre[10];\n");
    printf("    printf(\"Introduce tu nombre: \");\n");
    printf("    if (fgets(nombre, sizeof(nombre), stdin)) {\n");
    printf("        // Eliminar el salto de lÃ­nea si existe\n");
    printf("        nombre[strcspn(nombre, \"\\n\")] = '\\0';\n");
    printf("        printf(\"Hola, %%s\\n\", nombre);\n");
    printf("    } else {\n");
    printf("        printf(\"Error al leer la entrada.\\n\");\n");
    printf("    }\n");
    printf("    return 0;\n");
    printf("}\n\n");
    
    printf("âœ… VENTAJAS DE LA VERSIÃ“N SEGURA:\n");
    printf("â€¢ fgets() limita la lectura al tamaÃ±o del buffer\n");
    printf("â€¢ Siempre null-termina la cadena\n");
    printf("â€¢ Maneja errores de entrada\n");
    printf("â€¢ Elimina el salto de lÃ­nea correctamente\n");
    printf("â€¢ Previene buffer overflow completamente\n");
    printf("â€¢ CÃ³digo predecible y seguro\n\n");
    
    printf("ğŸ§ª DEMOSTRACIÃ“N PRÃCTICA:\n");
    printf("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n");
    printf("Ahora probaremos la versiÃ³n segura.\n");
    printf("Buffer disponible: 10 caracteres (incluyendo \\0)\n");
    printf("Prueba introducir mÃ¡s de 9 caracteres...\n\n");
    
    char nombre[10];
    printf("Introduce tu nombre: ");
    fflush(stdout);
    
    resultado_entrada_t resultado = entrada_cadena_segura(nombre, sizeof(nombre), stdin);
    
    if (resultado == ENTRADA_OK) {
        printf("\nâœ… Entrada exitosa!\n");
        printf("Contenido del buffer: '%s'\n", nombre);
        printf("Longitud real: %zu caracteres\n", strlen(nombre));
        printf("Hola, %s\n", nombre);
    } else if (resultado == ENTRADA_ERROR_BUFFER_OVERFLOW) {
        printf("\nâš ï¸  Â¡Intento de overflow detectado!\n");
        printf("La entrada fue truncada de forma segura.\n");
        printf("Contenido del buffer: '%s'\n", nombre);
        printf("El buffer permaneciÃ³ dentro de los lÃ­mites seguros.\n");
        printf("Hola, %s (truncado)\n", nombre);
    } else {
        printf("\nâŒ Error al leer entrada: %s\n", entrada_error_string(resultado));
    }
    
    printf("\nğŸ“Š ANÃLISIS:\n");
    printf("â€¢ El buffer nunca fue corrompido\n");
    printf("â€¢ La memoria adyacente estÃ¡ protegida\n");
    printf("â€¢ El programa no crasheÃ³\n");
    printf("â€¢ Se detectÃ³ y manejÃ³ el overflow\n");
}

/**
 * @brief Demo completo de entrada segura
 */
void demo_entrada_completa(void) {
    printf("\n");
    printf("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n");
    printf("â•‘              DEMO COMPLETO: ENTRADA SEGURA                  â•‘\n");
    printf("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    printf("\n");
    
    printf("Este demo recopila informaciÃ³n personal usando entrada segura.\n");
    printf("Observa cÃ³mo se valida cada campo y se manejan los errores.\n\n");
    
    // InformaciÃ³n del usuario
    struct {
        char nombre[32];
        char apellido[32];
        int edad;
        char email[64];
        double altura;
        char telefono[16];
    } usuario;
    
    // Limpiar estructura
    memset(&usuario, 0, sizeof(usuario));
    
    // Recopilar nombre
    config_entrada_t config;
    entrada_init_config(&config);
    config.trim_whitespace = true;
    config.permitir_vacio = false;
    strcpy(config.prompt, "Nombre (solo letras): ");
    strcpy(config.error_message, "âŒ El nombre debe contener solo letras.");
    
    bool nombre_valido = false;
    while (!nombre_valido) {
        if (entrada_linea_configurada(usuario.nombre, sizeof(usuario.nombre), &config, NULL) == ENTRADA_OK) {
            if (validar_solo_letras(usuario.nombre) && validar_longitud(usuario.nombre, 2, 30)) {
                nombre_valido = true;
                printf("âœ… Nombre aceptado: %s\n", usuario.nombre);
            } else {
                printf("âŒ Nombre invÃ¡lido. Debe contener solo letras (2-30 caracteres).\n");
            }
        }
    }
    
    // Recopilar apellido
    strcpy(config.prompt, "Apellido (solo letras): ");
    bool apellido_valido = false;
    while (!apellido_valido) {
        if (entrada_linea_configurada(usuario.apellido, sizeof(usuario.apellido), &config, NULL) == ENTRADA_OK) {
            if (validar_solo_letras(usuario.apellido) && validar_longitud(usuario.apellido, 2, 30)) {
                apellido_valido = true;
                printf("âœ… Apellido aceptado: %s\n", usuario.apellido);
            } else {
                printf("âŒ Apellido invÃ¡lido. Debe contener solo letras (2-30 caracteres).\n");
            }
        }
    }
    
    // Recopilar edad
    if (entrada_entero_seguro(&usuario.edad, 0, 120, "Edad") == ENTRADA_OK) {
        printf("âœ… Edad aceptada: %d aÃ±os\n", usuario.edad);
    }
    
    // Recopilar email
    strcpy(config.prompt, "Email: ");
    strcpy(config.error_message, "âŒ Formato de email invÃ¡lido.");
    bool email_valido = false;
    while (!email_valido) {
        if (entrada_linea_configurada(usuario.email, sizeof(usuario.email), &config, NULL) == ENTRADA_OK) {
            if (validar_email(usuario.email)) {
                email_valido = true;
                printf("âœ… Email aceptado: %s\n", usuario.email);
            } else {
                printf("âŒ Email invÃ¡lido. Formato esperado: usuario@dominio.com\n");
            }
        }
    }
    
    // Recopilar altura
    if (entrada_flotante_seguro(&usuario.altura, 0.5, 3.0, "Altura en metros") == ENTRADA_OK) {
        printf("âœ… Altura aceptada: %.2f m\n", usuario.altura);
    }
    
    // Recopilar telÃ©fono
    strcpy(config.prompt, "TelÃ©fono (solo nÃºmeros): ");
    strcpy(config.error_message, "âŒ El telÃ©fono debe contener solo nÃºmeros.");
    bool telefono_valido = false;
    while (!telefono_valido) {
        if (entrada_linea_configurada(usuario.telefono, sizeof(usuario.telefono), &config, NULL) == ENTRADA_OK) {
            if (validar_solo_numeros(usuario.telefono) && validar_longitud(usuario.telefono, 8, 15)) {
                telefono_valido = true;
                printf("âœ… TelÃ©fono aceptado: %s\n", usuario.telefono);
            } else {
                printf("âŒ TelÃ©fono invÃ¡lido. Debe contener solo nÃºmeros (8-15 dÃ­gitos).\n");
            }
        }
    }
    
    // Mostrar resumen
    printf("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n");
    printf("â•‘                    INFORMACIÃ“N RECOPILADA                   â•‘\n");
    printf("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    printf("Nombre completo: %s %s\n", usuario.nombre, usuario.apellido);
    printf("Edad: %d aÃ±os\n", usuario.edad);
    printf("Email: %s\n", usuario.email);
    printf("Altura: %.2f metros\n", usuario.altura);
    printf("TelÃ©fono: %s\n", usuario.telefono);
    printf("\nâœ… Todos los datos fueron validados y son seguros de usar.\n");
}

/**
 * @brief FunciÃ³n principal
 */
int main(void) {
    int opcion;
    char input[8];
    
    printf("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n");
    printf("â•‘                 ENTRADA SEGURA v%s                       â•‘\n", ENTRADA_SEGURA_VERSION);
    printf("â•‘              Ejercicio 094 - Seguridad                      â•‘\n");
    printf("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    printf("\nReemplazo de funciones inseguras por alternativas robustas\n");
    printf("Aprende a prevenir buffer overflow y vulnerabilidades de entrada\n");
    
    while (1) {
        mostrar_menu();
        
        if (entrada_cadena_segura(input, sizeof(input), stdin) != ENTRADA_OK) {
            printf("âŒ Error al leer opciÃ³n\n");
            continue;
        }
        
        opcion = atoi(input);
        
        switch (opcion) {
            case 1:
                demo_codigo_original();
                break;
                
            case 2:
                tutorial_entrada_segura();
                break;
                
            case 3:
                demo_tipos_entrada();
                break;
                
            case 4:
                demo_validacion();
                break;
                
            case 5:
                demo_configuracion_avanzada();
                break;
                
            case 6:
                demo_stress_test();
                break;
                
            case 7:
                mostrar_vulnerabilidades_comunes();
                break;
                
            case 8:
                mostrar_buenas_practicas();
                break;
                
            case 9:
                comparar_funciones_seguridad();
                break;
                
            case 0:
                printf("\nâœ… Â¡Gracias por aprender sobre entrada segura!\n");
                printf("Recuerda siempre:\n");
                printf("â€¢ Nunca uses gets()\n");
                printf("â€¢ Siempre especifica lÃ­mites de buffer\n");
                printf("â€¢ Valida toda entrada del usuario\n");
                printf("â€¢ Maneja errores apropiadamente\n");
                printf("\nğŸ”’ Â¡CÃ³digo seguro es cÃ³digo responsable!\n");
                return 0;
                
            default:
                printf("\nâŒ OpciÃ³n invÃ¡lida. Introduce un nÃºmero del 0-9.\n");
                break;
        }
        
        if (opcion >= 1 && opcion <= 9) {
            printf("\nPresiona Enter para continuar...");
            entrada_cadena_segura(input, sizeof(input), stdin);
        }
    }
    
    return 0;
}
